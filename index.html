<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>営業支援マニュアルポータル</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
<header class="site-header">
  <div class="logo">Sales Ops Manual</div>
  <input id="global-search" class="search" type="search" placeholder="キーワードを入力してください" />
</header>

<main class="layout">
  <!-- 左：大項目 → 直下に中項目（アコーディオン表示） -->
  <nav class="sidebar" aria-label="メインメニュー">
    <ul id="primary-menu" class="menu"></ul>
  </nav>

  <!-- 右：常にランディング（添付イメージ風） -->
  <section class="content">
    <!-- HERO（大きい検索フィールドと絞り込み） -->
    <div class="hero">
      <div class="hero-search">
        <input type="search" placeholder="キーワードを入力して下さい" aria-label="サイト内検索" />
        <button class="btn-filter" type="button">絞り込み</button>
      </div>
    </div>

    <!-- 新着記事 -->
    <section class="home-section">
      <h2 class="home-h2">新着記事</h2>
      <ul class="article-list" id="latest-list">
        <!-- JSでダミーデータ投入。運用時はビルドや手動更新でOK -->
      </ul>
    </section>

    <!-- 人気記事（カテゴリごとにランキング） -->
    <section class="home-section">
      <h2 class="home-h2">人気記事</h2>
      <div class="popular-grid" id="popular-grid">
        <!-- JSでカードを生成 -->
      </div>
    </section>
  </section>
</main>

<footer class="site-footer">© <span id="y"></span> Link innovation</footer>

<script>
  // --- 左メニュー用データ ---
  const NAV = [
    {
      id: "salesforce", label: "SFA：Salesforce",
      items: [
        { label: "はじめに（運用方針）", href: "pages/salesforce/intro.html" },
        { label: "取引先・取引先責任者の登録", href: "pages/salesforce/account-contact.html" },
        { label: "商談の作成〜フェーズ管理", href: "pages/salesforce/opportunity.html" },
        { label: "レポート／ダッシュボード", href: "pages/salesforce/report.html" },
        { label: "活動・ToDo・Chatter", href: "pages/salesforce/activity.html" },
      ]
    },
    {
      id: "sansan", label: "CRM：Sansan",
      items: [
        { label: "はじめに（基本操作）", href: "pages/sansan/intro.html" },
        { label: "名刺の取り込みと表記統一", href: "pages/sansan/import-normalize.html" },
        { label: "人物統合と重複解消", href: "pages/sansan/merge.html" },
        { label: "タグ付けと共有", href: "pages/sansan/tag-share.html" },
        { label: "Salesforce連携", href: "pages/sansan/sf-sync.html" },
      ]
    },
    {
      id: "accountengagement", label: "MA：Account Engagement",
      items: [
        { label: "はじめに（概念整理）", href: "pages/ae/intro.html" },
        { label: "フォーム／LPの作成", href: "pages/ae/forms-landing.html" },
        { label: "スコアリング／グレーディング", href: "pages/ae/scoring-grading.html" },
        { label: "オートメーション／エンゲージメント", href: "pages/ae/engagement.html" },
        { label: "Salesforce連携・同期", href: "pages/ae/sf-integration.html" },
      ]
    },
    {
      id: "getting-started", label: "共通：初期セットアップ",
      items: [
        { label: "アカウント発行フロー", href: "pages/common/accounts.html" },
        { label: "権限・ロールの考え方", href: "pages/common/roles.html" },
        { label: "命名規則とID体系", href: "pages/common/naming.html" },
        { label: "連携マップ（全体像）", href: "pages/common/integration-map.html" },
        { label: "トラブルシュートの基本", href: "pages/common/troubleshoot.html" },
      ]
    },
    {
      id: "governance", label: "共通：データガバナンス",
      items: [
        { label: "重複チェックの運用", href: "pages/common/dedupe.html" },
        { label: "項目設計ガイド", href: "pages/common/field-design.html" },
        { label: "データ品質監視", href: "pages/common/data-quality.html" },
        { label: "匿名化・削除ポリシー", href: "pages/common/privacy.html" },
        { label: "変更申請フロー", href: "pages/common/change-request.html" },
      ]
    },
    {
      id: "faq", label: "FAQ／ベストプラクティス",
      items: [
        { label: "パーミッションで詰まったら", href: "pages/faq/permissions.html" },
        { label: "レポート設計のコツ", href: "pages/faq/reporting-tips.html" },
        { label: "名寄せの落とし穴", href: "pages/faq/merge-pitfalls.html" },
        { label: "MAとSFAの同期遅延", href: "pages/faq/sync-latency.html" },
        { label: "問い合わせ先", href: "pages/faq/contact.html" },
      ]
    },
  ];

  // --- 右側：ダミーの新着＆人気データ（運用に合わせて差し替え） ---
  const LATEST = [
    { title: "日報の書き方", date: "2025.03.23", tag:"全社", href:"pages/faq/reporting-tips.html" },
    { title: "電話対応", date: "2025.03.27", tag:"営業部", href:"pages/faq/permissions.html" },
    { title: "全社MTG資料", date: "2025.03.19", tag:"資料", href:"pages/common/integration-map.html" },
  ];
  const POPULAR = [
    { cat:"全社", items:[
      { title:"新入社員マニュアル", href:"pages/common/accounts.html" },
      { title:"名刺交換", href:"pages/sansan/intro.html" },
      { title:"日報の書き方", href:"pages/faq/reporting-tips.html" },
    ]},
    { cat:"営業部", items:[
      { title:"電話対応", href:"pages/faq/permissions.html" },
      { title:"メール設定", href:"pages/ae/forms-landing.html" },
      { title:"支払いについて", href:"pages/common/privacy.html" },
    ]}
  ];

  const primaryMenu = document.getElementById('primary-menu');

  // 大項目＋サブメニュー（中項目）描画
  NAV.forEach((s) => {
    const li = document.createElement('li');
    li.className = 'menu-item';
    li.innerHTML = `
      <button class="menu-btn" data-id="${s.id}">${s.label}</button>
      <ul class="submenu" data-parent="${s.id}" hidden></ul>
    `;
    primaryMenu.appendChild(li);
  });

  function openSubmenu(id) {
    // すべて畳む
    document.querySelectorAll('.submenu').forEach(ul => { ul.hidden = true; ul.innerHTML=''; });
    document.querySelectorAll('.menu-btn').forEach(b => b.classList.toggle('active', b.dataset.id === id));

    const sec = NAV.find(s => s.id === id);
    if (!sec) return;
    const holder = document.querySelector(`.submenu[data-parent="${id}"]`);
    sec.items.forEach(item => {
      const li = document.createElement('li');
      li.innerHTML = `<a class="submenu-link" href="${item.href}">${item.label}</a>`;
      holder.appendChild(li);
    });
    holder.hidden = false;
  }

  primaryMenu.addEventListener('click', (e) => {
    if (!e.target.matches('.menu-btn')) return;
    const id = e.target.dataset.id;
    const isActive = e.target.classList.contains('active');
    if (isActive) {
      // 閉じる
      document.querySelector(`.submenu[data-parent="${id}"]`).hidden = true;
      e.target.classList.remove('active');
    } else {
      openSubmenu(id);
    }
    // 右側は常にランディングのまま（変更なし）
  });

  // 新着リスト投入
  const latestList = document.getElementById('latest-list');
  LATEST.forEach(a => {
    const li = document.createElement('li');
    li.className = 'article-item';
    li.innerHTML = `
      <a href="${a.href}">
        <div class="thumb" aria-hidden="true"></div>
        <div class="meta">
          <div class="title">${a.title}</div>
          <div class="sub"><span class="date">${a.date}</span>・<span class="tag">${a.tag}</span></div>
        </div>
      </a>`;
    latestList.appendChild(li);
  });

  // 人気記事（カテゴリ別カード）
  const popularGrid = document.getElementById('popular-grid');
  POPULAR.forEach(block => {
    const card = document.createElement('div');
    card.className = 'pop-card';
    card.innerHTML = `
      <div class="pop-head"><span class="pop-tag"> ${block.cat} </span></div>
      <ol class="pop-ol">
        ${block.items.map((it,i)=>`<li><a href="${it.href}"><span class="rank">${i+1}.</span> ${it.title}</a></li>`).join('')}
      </ol>
    `;
    popularGrid.appendChild(card);
  });

  document.getElementById('y').textContent = new Date().getFullYear();
  // ===== 検索UI：DOM参照（既存の検索バーにidを振ってください） =====
  const searchInput  = document.getElementById('global-search'); // 既存headerの検索
  // ヒーロー検索にも id 付与している場合は片方を使い回しでOK
  // <input id="hero-search-input"> <button id="hero-filter-btn">
  const heroBox = document.querySelector('.hero-search input');
  const heroBtn = document.querySelector('.btn-filter');

  // 結果描画先（右カラムに結果ボックスを動的追加）
  const contentEl = document.querySelector('.content');
  let resultBox = null;
  function ensureResultBox(){
    if (resultBox) return resultBox;
    resultBox = document.createElement('section');
    resultBox.id = 'search-results';
    resultBox.className = 'home-section';
    resultBox.innerHTML = `<h2 class="home-h2">検索結果</h2><div class="result-head"><span id="result-count"></span><button id="clear-search" class="btn-clear" type="button">クリア</button></div><ul class="result-list"></ul>`;
    contentEl.prepend(resultBox);
    document.getElementById('clear-search').addEventListener('click', clearSearch);
    return resultBox;
  }

  let SEARCH_INDEX = null;  // 初回だけ取得してキャッシュ
  async function loadIndex(){
    if (SEARCH_INDEX) return SEARCH_INDEX;
    const res = await fetch('search-index.json', {cache: 'no-store'});
    SEARCH_INDEX = await res.json();
    return SEARCH_INDEX;
  }

  function tokenize(q){ return q.trim().toLowerCase().split(/\s+/).filter(Boolean); }

  function searchDocs(index, query){
    const tokens = tokenize(query);
    if (!tokens.length) return [];
    // ANDマッチ（全トークンがいずれかのフィールドに含まれる）
    return index
      .map(doc => {
        const hay = (doc.title + ' ' + (doc.tags||[]).join(' ') + ' ' + (doc.body||'')).toLowerCase();
        const ok = tokens.every(t => hay.includes(t));
        // スコア：単純に一致総数＋タイトル命中で加点
        let score = 0;
        if (ok){
          tokens.forEach(t => {
            if (doc.title.toLowerCase().includes(t)) score += 3;
            if ((doc.tags||[]).join(' ').toLowerCase().includes(t)) score += 2;
            if ((doc.body||'').toLowerCase().includes(t)) score += 1;
          });
        }
        return ok ? {...doc, score} : null;
      })
      .filter(Boolean)
      .sort((a,b)=> b.score - a.score)
      .slice(0,50);
  }

  function renderResults(items, query){
    ensureResultBox();
    // 既存のホームセクションは非表示にしない（＝右側の“既存レイアウトに影響なし”）
    // ただし結果はページ上部に追加表示
    const ul = resultBox.querySelector('.result-list');
    ul.innerHTML = items.map(it => `
      <li class="result-item">
        <a href="${it.url}">
          <div class="title">${it.title}</div>
          <div class="snippet">${(it.body||'').replace(/\s+/g,' ').slice(0,120)}${(it.body||'').length>120?'…':''}</div>
          <div class="tags">${(it.tags||[]).map(t=>`<span>#${t}</span>`).join(' ')}</div>
        </a>
      </li>
    `).join('') || `<li class="result-empty">該当するページが見つかりませんでした。</li>`;
    document.getElementById('result-count').textContent = `「${query}」の結果：${items.length}件`;
    resultBox.style.display = '';
  }

  function clearSearch(){
    if (resultBox) { resultBox.style.display = 'none'; }
    if (searchInput) searchInput.value = '';
    if (heroBox) heroBox.value = '';
  }

  async function doSearch(q){
    const index = await loadIndex();
    const items = searchDocs(index, q);
    renderResults(items, q);
  }

  function onSubmitFrom(el){
    const q = el.value.trim();
    if (!q) return;
    doSearch(q);
  }

  // 検索イベント（header・heroの両方につなぐ）
  if (searchInput){
    searchInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') onSubmitFrom(e.target);
    });
  }
  if (heroBox){
    heroBox.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') onSubmitFrom(e.target);
    });
  }
  if (heroBtn){
    heroBtn.addEventListener('click', ()=> onSubmitFrom(heroBox || searchInput));
  }

  // 既存：新着・人気・メニュー描画のコード（前回のまま）
  // …（省略：すでに入っている処理をそのまま置いてください）…

  document.getElementById('y').textContent = new Date().getFullYear();
</script>
</body>
</html>
