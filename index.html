<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>営業支援マニュアルポータル</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
<header class="site-header">
  <div class="logo">Sales Ops Manual</div>
  <input id="global-search" class="search" type="search" placeholder="キーワードを入力してください" />
</header>

<main class="layout">
  <!-- 左：大項目 + 直下に中項目（アコーディオン展開） -->
  <nav class="sidebar" aria-label="メインメニュー">
    <ul id="primary-menu" class="menu"></ul>
  </nav>

  <!-- 右：ランディング（検索ヒーロー + 新着 + 人気） -->
  <section class="content">
    <div class="hero">
      <div class="hero-search">
        <input id="hero-search-input" type="search" placeholder="キーワードを入力して下さい" aria-label="サイト内検索" />
        <button id="hero-filter-btn" class="btn-filter" type="button">絞り込み</button>
      </div>
    </div>

    <!-- 検索結果（JSでprepend、初期は非表示） -->
    <section id="search-results" class="home-section" style="display:none;">
      <h2 class="home-h2">検索結果</h2>
      <div class="result-head">
        <span id="result-count"></span>
        <button id="clear-search" class="btn-clear" type="button">クリア</button>
      </div>
      <div class="result-grid" id="result-grid"></div>
    </section>

    <!-- 新着記事（例） -->
    <section class="home-section">
      <h2 class="home-h2">新着記事</h2>
      <ul class="article-list" id="latest-list"></ul>
    </section>

    <!-- 人気記事（例） -->
    <section class="home-section">
      <h2 class="home-h2">人気記事</h2>
      <div class="popular-grid" id="popular-grid"></div>
    </section>
  </section>
</main>

<footer class="site-footer">© <span id="y"></span> Link innovation</footer>

<script>
  // ====== ナビ（左メニュー）データ：添付テーブルを反映 ======
  const NAV = [
    {
      id: "customers", label: "顧客管理",
      items: [
        { label: "基本ルール・定義",         href: "pages/customers/basics.html" },
        { label: "名刺登録方法",             href: "pages/customers/business-card.html" },
        { label: "リード登録方法",           href: "pages/customers/lead-create.html" },
        { label: "取引先責任者登録方法",     href: "pages/customers/contact-create.html" },
        { label: "取引先登録方法",           href: "pages/customers/account-create.html" },
      ]
    },
    {
      id: "deals", label: "案件管理",
      items: [
        { label: "基本ルール・定義",           href: "pages/deals/basics.html" },
        { label: "新規案件（リード）",         href: "pages/deals/opportunity-new-lead.html" },
        { label: "新規案件（取引先責任者）",   href: "pages/deals/opportunity-new-contact.html" },
        { label: "既存案件（リード）",         href: "pages/deals/opportunity-existing-lead.html" },
        { label: "既存案件（取引先責任者）",   href: "pages/deals/opportunity-existing-contact.html" },
      ]
    },
    {
      id: "activities", label: "活動管理",
      items: [
        { label: "基本ルール・定義",   href: "pages/activities/basics.html" },
        { label: "ToDoの登録",         href: "pages/activities/todo.html" },
        { label: "行動の登録",         href: "pages/activities/activity-log.html" },
        { label: "メール",             href: "pages/activities/email.html" },
        { label: "Gmail連携",          href: "pages/activities/gmail-integration.html" },
      ]
    },
    {
      id: "programs", label: "施策管理",
      items: [
        { label: "基本ルール・定義",           href: "pages/programs/basics.html" },
        { label: "施策一覧",                   href: "pages/programs/programs-list.html" },
        { label: "施策作成",                   href: "pages/programs/program-create.html" },
        { label: "施策ステータス更新",         href: "pages/programs/program-status.html" },
        { label: "ダッシュボード・レポート一覧", href: "pages/programs/dashboards-reports.html" },
      ]
    },
    {
      id: "governance", label: "管理体制",
      items: [
        { label: "管理部門・ステークホルダー", href: "pages/admin/stakeholders.html" },
        { label: "アカウント発行",             href: "pages/admin/accounts-issue.html" },
        { label: "項目権限の追加・変更",       href: "pages/admin/permissions.html" },
        { label: "データガバナンス",           href: "pages/admin/governance.html" },
        { label: "問合せ先",                   href: "pages/admin/contact.html" },
      ]
    },
  ];

  // ====== 新着 / 人気（ダミーを新階層へ差し替え） ======
  const LATEST = [
    { title: "名刺登録方法の更新", date: "2025.03.27", tag:"顧客管理", href:"pages/customers/business-card.html" },
    { title: "新規案件（リード）の手順", date: "2025.03.23", tag:"案件管理", href:"pages/deals/opportunity-new-lead.html" },
    { title: "施策ダッシュボード集", date: "2025.03.19", tag:"施策管理", href:"pages/programs/dashboards-reports.html" },
  ];
  const POPULAR = [
    { cat:"顧客管理", items:[
      { title:"取引先登録方法", href:"pages/customers/account-create.html" },
      { title:"取引先責任者登録方法", href:"pages/customers/contact-create.html" },
      { title:"リード登録方法", href:"pages/customers/lead-create.html" },
    ]},
    { cat:"案件管理", items:[
      { title:"新規案件（取引先責任者）", href:"pages/deals/opportunity-new-contact.html" },
      { title:"既存案件（リード）", href:"pages/deals/opportunity-existing-lead.html" },
      { title:"既存案件（取引先責任者）", href:"pages/deals/opportunity-existing-contact.html" },
    ]}
  ];

  // ====== 左メニュー描画 ======
  const primaryMenu = document.getElementById('primary-menu');
  NAV.forEach((s) => {
    const li = document.createElement('li');
    li.className = 'menu-item';
    li.innerHTML = `
      <button class="menu-btn" data-id="${s.id}">${s.label}</button>
      <ul class="submenu" data-parent="${s.id}" hidden></ul>
    `;
    primaryMenu.appendChild(li);
  });

  function openSubmenu(id) {
    // 全て畳む → 対象のみ開く
    document.querySelectorAll('.submenu').forEach(ul => { ul.hidden = true; ul.innerHTML = ''; });
    document.querySelectorAll('.menu-btn').forEach(b => b.classList.toggle('active', b.dataset.id === id));
    const sec = NAV.find(s => s.id === id);
    if (!sec) return;
    const holder = document.querySelector(`.submenu[data-parent="${id}"]`);
    sec.items.forEach(item => {
      const li = document.createElement('li');
      li.innerHTML = `<a class="submenu-link" href="${item.href}">${item.label}</a>`;
      holder.appendChild(li);
    });
    holder.hidden = false;
  }

  primaryMenu.addEventListener('click', (e) => {
    if (!e.target.matches('.menu-btn')) return;
    const id = e.target.dataset.id;
    const isActive = e.target.classList.contains('active');
    if (isActive) {
      document.querySelector(`.submenu[data-parent="${id}"]`).hidden = true;
      e.target.classList.remove('active');
    } else {
      openSubmenu(id);
    }
  });

  // ====== ランディング生成（新着・人気） ======
  const latestList = document.getElementById('latest-list');
  LATEST.forEach(a => {
    const li = document.createElement('li');
    li.className = 'article-item';
    li.innerHTML = `
      <a href="${a.href}">
        <div class="thumb" aria-hidden="true"></div>
        <div class="meta">
          <div class="title">${a.title}</div>
          <div class="sub"><span class="date">${a.date}</span>・<span class="tag">${a.tag}</span></div>
        </div>
      </a>`;
    latestList.appendChild(li);
  });

  const popularGrid = document.getElementById('popular-grid');
  POPULAR.forEach(block => {
    const card = document.createElement('div');
    card.className = 'pop-card';
    card.innerHTML = `
      <div class="pop-head"><span class="pop-tag">${block.cat}</span></div>
      <ol class="pop-ol">
        ${block.items.map((it,i)=>`<li><a href="${it.href}"><span class="rank">${i+1}.</span> ${it.title}</a></li>`).join('')}
      </ol>
    `;
    popularGrid.appendChild(card);
  });

  // ====== 検索（TOP内でカード表示） ======
  const searchInput = document.getElementById('global-search');
  const heroInput = document.getElementById('hero-search-input');
  const heroBtn   = document.getElementById('hero-filter-btn');
  const resultWrap  = document.getElementById('search-results');
  const resultGrid  = document.getElementById('result-grid');
  const resultCount = document.getElementById('result-count');
  const clearBtn    = document.getElementById('clear-search');

  let SEARCH_INDEX = null;
  async function loadIndex(){
    if (SEARCH_INDEX) return SEARCH_INDEX;
    const res = await fetch('search-index.json', {cache: 'no-store'});
    SEARCH_INDEX = await res.json();
    return SEARCH_INDEX;
  }
  const tokenize = q => q.trim().toLowerCase().split(/\s+/).filter(Boolean);

  function searchDocs(index, query){
    const tokens = tokenize(query);
    if (!tokens.length) return [];
    return index
      .map(doc => {
        const hay = (doc.title + ' ' + (doc.tags||[]).join(' ')).toLowerCase();
        const ok = tokens.every(t => hay.includes(t));
        let score = 0;
        if (ok){
          tokens.forEach(t => {
            if (doc.title.toLowerCase().includes(t)) score += 3;
            if ((doc.tags||[]).join(' ').toLowerCase().includes(t)) score += 1;
          });
        }
        return ok ? {...doc, score} : null;
      })
      .filter(Boolean)
      .sort((a,b)=> b.score - a.score)
      .slice(0,60);
  }

  function renderResults(items, query){
    resultWrap.style.display = '';
    resultCount.textContent = `「${query}」の結果：${items.length}件`;
    resultGrid.innerHTML = items.map(it => `
      <a class="result-card" href="${it.url}" title="${it.title}">
        <div class="result-title">${it.title}</div>
      </a>
    `).join('') || `<div class="result-empty">該当するページが見つかりませんでした。</div>`;
    resultWrap.scrollIntoView({behavior:'smooth', block:'start'});
  }

  function clearSearch(){
    resultWrap.style.display = 'none';
    resultGrid.innerHTML = '';
    resultCount.textContent = '';
    if (searchInput) searchInput.value = '';
    if (heroInput) heroInput.value = '';
  }
  clearBtn.addEventListener('click', clearSearch);

  async function doSearch(q){
    const index = await loadIndex();
    const items = searchDocs(index, q);
    renderResults(items, q);
  }
  function onSubmitFrom(el){
    const q = el.value.trim();
    if (!q) return;
    doSearch(q);
  }
  if (searchInput) searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') onSubmitFrom(e.target); });
  if (heroInput)   heroInput.addEventListener('keydown', e => { if (e.key === 'Enter') onSubmitFrom(e.target); });
  if (heroBtn)     heroBtn.addEventListener('click', () => onSubmitFrom(heroInput || searchInput));

  // 年表示
  document.getElementById('y').textContent = new Date().getFullYear();

  /* ===== サイドバーの出し入れ（ホットゾーン方式） ===== */
  (function(){
    const zone = document.createElement('div');
    zone.className = 'edge-hotzone';
    document.body.appendChild(zone);

    const OPEN_CLASS = 'sidebar-open';
    let closeTimer = null;

    const openSidebar = () => {
      if (closeTimer) { clearTimeout(closeTimer); closeTimer = null; }
      document.body.classList.add(OPEN_CLASS);
    };
    const maybeClose = () => {
      if (closeTimer) clearTimeout(closeTimer);
      closeTimer = setTimeout(() => {
        document.body.classList.remove(OPEN_CLASS);
      }, 200);
    };
    zone.addEventListener('mouseenter', openSidebar);
    zone.addEventListener('mouseleave', maybeClose);

    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      sidebar.addEventListener('mouseenter', openSidebar);
      sidebar.addEventListener('mouseleave', maybeClose);
    }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') document.body.classList.remove(OPEN_CLASS);
    });
    document.body.classList.remove(OPEN_CLASS);
  })();
</script>
</body>
</html>
